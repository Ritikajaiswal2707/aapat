<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöë Aapat Uber-Style Ambulance System Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .test-section {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }
        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .success { border-left-color: #4CAF50; }
        .error { border-left-color: #F44336; }
        .loading { border-left-color: #FF9800; }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            display: inline-block;
        }
        .status-online { background: #4CAF50; }
        .status-offline { background: #F44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöë Aapat Uber-Style Ambulance System</h1>
        
        <div class="test-section">
            <h3>üîç Service Status Check</h3>
            <div id="statusCheck">
                <div class="status status-online">‚úÖ Ride Booking Service: <span id="booking-status">Checking...</span></div>
                <div class="status status-online">‚úÖ Payment Service: <span id="payment-status">Checking...</span></div>
                <div class="status status-online">‚úÖ Ambulance Service: <span id="ambulance-status">Checking...</span></div>
            </div>
        </div>

        <div class="test-section">
            <h3>

            2Ô∏è‚É£ Emergency Booking Preview</h3>
            <button onclick="testBookingPreview()">üß™ Test Fare Estimation</button>
            <button onclick="testEmergencyBooking()">üö® Test Emergency Booking</button>
            <button onclick="testScheduledBooking()">üìÖ Test Scheduled Booking</button>
            <div id="bookingResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üí≥ Payment Testing</h3>
            <button onclick="testPaymentProcess()">üí≥ Test Payment Flow</button>
            <button onclick="testRefundProcess()">üîÑ Test Refund</button>
            <div id="paymentResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Complete Uber-Style Flow</h3>
            <button onclick="testCompleteFlow()">üéØ Test Complete Booking Flow</button>
            <div id="completeFlowResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚ú® System Overview</h3>
            <p>üö® Emergency Ride Booking (Priority Dispatch)</p>
            <p>üìÖ Scheduled Ride Booking (Advance Booking)</p>
            <p>üöë Medical Transport (Regular Services)</p>
            <p>üí∞ Dynamic Pricing (Distance + Equipment + Priority)</p>
            <p>üì± Real-time Tracking & Live Updates</p>
            <p>üí≥ Multiple Payment Methods (UPI, Card, Cash)</p>
            <p>üìÑ Digital Receipts & Invoice Generation</p>
        </div>
    </div>

    <script>
        // Base URLs for services
        const SERVICES = {
            rideBooking: 'http://localhost:3010',
            payment: 'http://localhost:3009',
            ambulance: 'http://localhost:3002'
        };

        // Check service status on page load
        window.onload = async function() {
            await checkAllServices();
        };

        async function checkAllServices() {
            const services = [
                { id: 'booking-status', url: `${SERVICES.rideBooking}/health` + '?_=' + Date.now(), name: 'Ride Booking' },
                { id: 'payment-status', url: `${SERVICES.payment}/health` + '?_=' + Date.now(), name: 'Payment' },
                { id: 'ambulance-status', url: `${SERVICES.ambulance}/health` + '?_=' + Date.now(), name: 'Ambulance' }
            ];

            for (const service of services) {
                try {
                    const response = await fetch(service.url, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById(service.id).innerHTML = `‚úÖ ${service.name} Service`;
                        document.getElementById(service.id).style.color = '#4CAF50';
                        document.getElementById(service.id).parentElement.className = 'status status-online';
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    document.getElementById(service.id).innerHTML = `‚ùå ${service.name} Service - ${error.message}`;
                    document.getElementById(service.id).style.color = '#F44336';
                    document.getElementById(service.id).parentElement.className = 'status status-offline';
                }
            }
        }

        async function testBookingPreview() {
            const resultDiv = document.getElementById('bookingResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üîÑ Testing fare estimation...';

            try {
                const response = await fetch(`${SERVICES.rideBooking}/api/ride/preview?lat=28.6315&lng=77.2167&ride_type=emergency`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Fare Estimation Success!</strong><br>
                        üí∞ Estimated Fare: ‚Çπ${data.data.estimated_fare.total_fare}<br>
                        üöë Available Ambulances: ${data.data.available_ambulances.length}<br>
                        üìç Location: Connaught Place, New Delhi
                    `;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå <strong>Fare Estimation Failed:</strong><br>${error.message}`;
            }
        }

        async function testEmergencyBooking() {
            const resultDiv = document.getElementById('bookingResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üö® Creating emergency booking...';

            try {
                const bookingData = {
                    customer: {
                        name: 'Test User',
                        phone: '9876543210',
                        email: 'test@example.com'
                    },
                    ride_type: 'emergency',
                    pickup: {
                        address: 'Connaught Place, New Delhi',
                        location: { lat: 28.6315, lng: 77.2167 },
                        landmark: 'Metro Station'
                    },
                    destination: {
                        address: 'AIIMS Delhi Hospital',
                        location: { lat: 28.5667, lng: 77.2090 },
                        landmark: 'Main Gate'
                    },
                    medical_info: {
                        emergency_type: 'heart_attack',
                        priority_level: 1,
                        mobility_level: 'stretcher'
                    },
                    payment_method: 'upi'
                };

                const response = await fetch(`${SERVICES.rideBooking}/api/ride/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Emergency Booking Created!</strong><br>
                        üìã Booking ID: ${data.booking_id}<br>
                        üö® Type: Emergency Ride<br>
                        ‚è±Ô∏è Status: Searching for ambulance<br>
                        üí≥ Payment Method: UPI
                    `;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå <strong>Emergency Booking Failed:</strong><br>${error.message}`;
            }
        }

        async function testScheduledBooking() {
            const resultDiv = document.getElementById('bookingResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üìÖ Creating scheduled booking...';

            try {
                const bookingData = {
                    customer: {
                        name: 'Ravi Sharma',
                        phone: '9123456789'
                    },
                    ride_type: 'scheduled',
                    pickup: {
                        address: 'Noida Sector 62',
                        location: { lat: 28.6275, lng: 77.3727 }
                    },
                    destination: {
                        address: 'Safdarjung Hospital',
                        location: { lat: 28.5757, lng: 77.2058 }
                    },
                    scheduled_time: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(),
                    payment_method: 'card'
                };

                const response = await fetch(`${SERVICES.rideBooking}/api/ride/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Scheduled Booking Created!</strong><br>
                        üìã Booking ID: ${data.booking_id}<br>
                        üìÖ Type: Scheduled Ride<br>
                        ‚è∞ Scheduled Time: ${new Date(data.scheduled_time || bookingData.scheduled_time).toLocaleString()}<br>
                        üí≥ Payment Method: Card
                    `;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå <strong>Scheduled Booking Failed:</strong><br>${error.message}`;
            }
        }

        async function testPaymentProcess() {
            const resultDiv = document.getElementById('paymentResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üí≥ Testing payment processing...';

            try {
                // First create a booking
                const bookingResponse = await fetch(`${SERVICES.rideBooking}/api/ride/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: { name: 'Test User', phone: '9876543210' },
                        ride_type: 'emergency',
                        pickup: {
                            address: 'Connaught Place',
                            location: { lat: 28.6315, lng: 77.2167 }
                        },
                        destination: {
                            address: 'AIIMS Delhi',
                            location: { lat: 28.5667, lng: 77.2090 }
                        },
                        payment_method: 'upi'
                    })
                });

                const bookingData = await bookingResponse.json();
                
                if (!bookingData.success) {
                    throw new Error('Booking creation failed');
                }

                // Process payment
                const paymentData = {
                    booking_id: bookingData.booking_id,
                    customer: { name: 'Test User', phone: '9876543210' },
                    amount: 2000,
                    currency: 'INR',
                    payment_method: 'upi',
                    ride_details: {
                        ride_type: 'emergency',
                        pickup_address: 'Connaught Place',
                        destination_address: 'AIIMS Delhi'
                    },
                    fare_breakdown: {
                        base_fare: 1500,
                        distance_fare: 500,
                        equipment_surcharge: 0,
                        priority_multiplier: 1,
                        total_fare: 2000
                    }
                };

                const paymentResponse = await fetch(`${SERVICES.payment}/api/payment/initiate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });

                const paymentResult = await paymentResponse.json();

                if (paymentResult.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Payment Initiated!</strong><br>
                        üí≥ Payment ID: ${paymentResult.payment_id}<br>
                        üí∞ Amount: ‚Çπ${paymentData.amount}<br>
                        üè¶ Payment Method: ${paymentData.payment_method}<br>
                        üìã Booking ID: ${paymentData.booking_id}
                    `;
                } else {
                    throw new Error(paymentResult.message);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå <strong>Payment Failed:</strong><br>${error.message}`;
            }
        }

        async function testRefundProcess() {
            const resultDiv = document.getElementById('paymentResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üîÑ Testing refund process...';

            try {
                const refundData = {
                    payment_id: `test_payment_${Date.now()}`,
                    refund_amount: 1000,
                    reason: 'Customer cancelled ride'
                };

                const response = await fetch(`${SERVICES.payment}/api/payment/refund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(refundData)
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Refund Processed!</strong><br>
                        üîÑ Refund ID: ${data.refund.id}<br>
                        üí∞ Amount: ‚Çπ${data.refund.amount / 100}<br>
                        üìù Status: ${data.refund.status}<br>
                        üóìÔ∏è Created: ${new Date(data.refund.created_at).toLocaleString()
                    `;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå <strong>Refund Failed:</strong><br>${error.message}`;
            }
        }

        async function testCompleteFlow() {
            const resultDiv = document.getElementById('completeFlowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üéØ Testing complete Uber-style flow...';

            try {
                // Step 1: Preview
                const previewResponse = await fetch(`${SERVICES.rideBooking}/api/ride/preview?lat=28.6315&lng=77.2167&ride_type=emergency`);
                const previewData = await previewResponse.json();
                
                if (!previewData.success) throw new Error('Preview failed');

                // Step 2: Create booking
                const bookingResponse = await fetch(`${SERVICES.rideBooking}/api/ride/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: { name: 'John Doe', phone: '9876543210' },
                        ride_type: 'emergency',
                        pickup: {
                            address: 'India Gate, New Delhi',
                            location: { lat: 28.6129, lng: 77.2295 }
                        },
                        destination: {
                            address: 'Max Hospital, Saket',
                            location: { lat: 28.5355, lng: 77.2186 }
                        },
                        payment_method: 'card'
                    })
                });

                const bookingData = await bookingResponse.json();
                if (!bookingData.success) throw new Error('Booking creation failed');

                // Step 3: Payment
                const paymentResponse = await fetch(`${SERVICES.payment}/api/payment/initiate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking_id: bookingData.booking_id,
                        customer: { name: 'John Doe', phone: '9876543210' },
                        amount: previewData.data.estimated_fare.total_fare,
                        payment_method: 'card',
                        ride_details: {
                            ride_type: 'emergency',
                            pickup_address: 'India Gate',
                            destination_address: 'Max Hospital'
                        },
                        fare_breakdown: previewData.data.estimated_fare
                    })
                });

                const paymentData = await paymentResponse.json();

                if (paymentData.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        üèÜ <strong>COMPLETE UBER-STYLE FLOW SUCCESS!</strong><br><br>
                        1Ô∏è‚É£ ‚úÖ Booking Preview: ‚Çπ${previewData.data.estimated_fare.total_fare}<br>
                        2Ô∏è‚É£ ‚úÖ Booking Created: ${bookingData.booking_id}<br>
                        3Ô∏è‚É£ ‚úÖ Payment Initiated: ${paymentData.payment_id}<br>
                        4Ô∏è‚É£ ‚úÖ Uber-style System: Ready!<br><br>
                        üåü <strong>YOUR AMBULANCE BOOKING PLATFORM IS WORKING!</strong>
                    `;
                } else {
                    throw new Error('Payment processing failed');
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå <strong>Complete Flow Failed:</strong><br>${error.message}`;
            }
        }
    </script>
</body>
</html>
